{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":"<p>Welcome to my site. I'm Emi and I develop applications as a hobby. Here you can find notes of concepts that caught my attention, several interests and random stuff. While some things may seem random, it has some relation to computers, programming, games and books.</p>"},{"location":"blog/","title":"Blog","text":""},{"location":"blog/2025/06/19/hello-world/","title":"Hello World!","text":"<p>Every beginning must be with a greeting to this world.</p> <p>I've been postponing this project for a long time. I've tried different tools in the mean time but none suited my needs until I found MKDocs a fascinating project for to organize documentation and collect my ideas into a blog. Its stack of tools includes Python as a backend, on the frontend it's Javascript, CSS, Typescript and HTML.</p> <p>This page will contain links to my projects that are soon to be shared with the hope to be useful, as well as, other interests that'll emerge with time.</p> <p>Thanks for reading.</p>"},{"location":"linux/","title":"Description","text":"<p>Here you can find notes about my system administration and other activities related to services and applications. All notes are based on Arch Linux used for desktop unless otherwise noted.</p>"},{"location":"linux/nut-monitor/","title":"Nut-Monitor","text":""},{"location":"linux/nut-monitor/#introduction","title":"Introduction","text":"<p>I've been doing system maintenance and discovered a few issues with my current setup, so I've decided to document the process and share it. </p> <p>I'm Using a CTB-1200 UPS. It's connected via usb. After following the wiki instruction and set up a basic configuration, the following files need to be modified for the installation to be effective.</p>"},{"location":"linux/nut-monitor/#configuration","title":"Configuration","text":""},{"location":"linux/nut-monitor/#driver-configuration","title":"Driver configuration","text":"<p>Not every model is compatible, I was lucky enough to find my hardware listed in Network UPS Tools page, it provides the required configuration parameters.</p> <p>There are several files that need to be modified according to the user's UPS model residing in the <code>/etc/nut</code> folder. </p> <pre><code>/etc/nut\n\u251c\u2500\u2500 hosts.conf\n\u251c\u2500\u2500 nut.conf\n\u251c\u2500\u2500 ups.conf # Driver Settings\n\u251c\u2500\u2500 upsd.conf\n\u251c\u2500\u2500 upsd.users # Required to send commands to the daemon\n\u251c\u2500\u2500 upsmon.conf # Daemon configuration\n\u251c\u2500\u2500 upssched.conf # Timer and command schedule\n\u251c\u2500\u2500 upssched-cmd # Custom user script\n\u251c\u2500\u2500 upsset.conf\n\u251c\u2500\u2500 upsstats.html\n\u2514\u2500\u2500 upsstats-single.html\n</code></pre>"},{"location":"linux/nut-monitor/#nutconf","title":"nut.conf","text":"<p>In this file, change the following line from 'none' to 'standalone' to enable the monitor.</p> <pre><code># Default values and file comments ommitted\nMODE=standalone \n</code></pre>"},{"location":"linux/nut-monitor/#upsconf","title":"ups.conf","text":"<p>This file is where the driver configuration is stored. Parameters compatibility will depend on the driver. The following are general purpose so they should work for most drivers.</p> <pre><code># Default values and file comments ommitted, \n# append configuration to desired driver.\n[ctb-1200]\n    driver = blazer_usb\n    port = auto\n    offdelay = 20\n    ondelay = 30\n    ignorelb\n    override.battery.charge.low = 20\n    override.battery.charge.warning = 40\n</code></pre>"},{"location":"linux/nut-monitor/#upsusers","title":"ups.users","text":"<p>This file is where the user configuration is stored. It's required to send commands to the daemon.</p> <pre><code>[dnloop]\n     password = 1212\n     upsmon master\n     actions = SET\n     instcmds = ALL\n</code></pre>"},{"location":"linux/nut-monitor/#upsmonconf","title":"upsmon.conf","text":"<p>This file is where the daemon configuration is stored. It provides an interface to send commands to the device.</p> <pre><code># Default values omitted\nSHUTDOWNCMD \"/sbin/shutdown -h +0\"\nNOTIFYCMD /usr/sbin/upssched\nNOTIFYFLAG ONLINE      SYSLOG+WALL+EXEC\nNOTIFYFLAG ONBATT      SYSLOG+WALL+EXEC\nNOTIFYFLAG LOWBATT     SYSLOG+WALL+EXEC\nNOTIFYFLAG REPLBATT    SYSLOG+WALL+EXEC\n\nMONITOR ctb-1200@localhost 1 dnloop 1212 master # same credentials as ups.users\n</code></pre>"},{"location":"linux/nut-monitor/#upsschedconf","title":"upssched.conf","text":"<p>This file is where the timer and command schedule is stored. Here we can tune the time to wait until power reconnection or shutdown. It's advisable to not wait too much in a power outage due to aging of battery, it's better to have a quick shutdown than a long one.</p> <pre><code># Default values omitted\nCMDSCRIPT /etc/nut/upssched-cmd\n\nPIPEFN /var/lib/nut/upssched/upssched.pipe\nLOCKFN /var/lib/nut/upssched/upssched.lock\n\nAT ONBATT * START-TIMER shutdown_onbatt 40 # value in seconds\nAT ONBATT * EXECUTE info_onbatt\n\nAT ONLINE * CANCEL-TIMER shutdown_onbatt\nAT ONLINE * EXECUTE ups-back-on-power\n\nAT LOWBATT * EXECUTE shutdown_lowbatt\n\nAT REPLBATT * EXECUTE replace_batt\n</code></pre> <p>/var/lib/nut/upssched/</p> <p>The pipe and lock files are required for the daemon to work and inform the logger of the status of executed commands.</p> <pre><code>touch upssched.pipe\ntouch upssched.lock\nchown nut:nut upssched.*\nchmod 770 upssched.*\n</code></pre>"},{"location":"linux/nut-monitor/#custom-user-script","title":"Custom user script","text":"<p>This script is where the custom commands are stored. It's called by <code>upssched.conf</code>. It can be modified to execute appropriate handling of services and notify event loggers. I'm only logging and forcing a shutdown for now.</p> <p>upssched-cmd</p> <pre><code>#! /bin/sh\ncase $1 in\n    shutdown_onbatt)\n        logger -t upsmon[upssched] \"shutdown_onbatt): Triggering shutdown after being on battery\"\n        /sbin/shutdown -h +0\n        ;;\n\n    shutdown_lowbatt)\n        logger -t upsmon[upssched] \"shutdown_lowbatt): Triggering shutdown when battery.charge.low is under 50%\"\n        /sbin/shutdown -h +0\n        ;;\n\n    info_onbatt)\n        logger -t upsmon[upssched] \"info_onbatt): Now on battery\"\n        ;;\n\n    ups-back-on-power)\n        logger -t upsmon[upssched] \"ups-back-on-power): UPS back on power\"\n        ;;\n\n    replace_batt)\n        message=\"Quick self-test indicates battery requires replacement\"\n        logger -t upsmon[upssched] \"replace_batt): $message\"\n        ;;\n\n    *)\n        logger -t upsmon[upssched] \"*) = Unrecognized command: $1\"\n        ;;\nesac\n</code></pre>"},{"location":"linux/nut-monitor/#systemd-targets","title":"Systemd Targets","text":"<p>These are systemd targets extracted from Arch wiki, they should be present after following along the guide.</p> <pre><code>\u256d\u2500 /etc/systemd/system/\n\nnut-driver@ctb-1200.service.d\n\u251c\u2500\u2500 nut-driver-enumerator-generated-checksum.conf\n\u251c\u2500\u2500 nut-driver-enumerator-generated.conf\n\u251c\u2500\u2500 nut-driver-enumerator-generated-devicename.conf\n\u2514\u2500\u2500 nut-driver-enumerator-generated-doclink.conf\nnut-driver@.service.d\n\u2514\u2500\u2500 nut-driver-enumerator-generated-checksum.conf\nnut-driver.target.wants\n\u2514\u2500\u2500 nut-driver@ctb-1200.service -&gt; /usr/lib/systemd/system/nut-driver@.service\nnut.target.wants\n\u251c\u2500\u2500 nut-driver-enumerator.service -&gt; /usr/lib/systemd/system/nut-driver-enumerator.service\n\u251c\u2500\u2500 nut-driver.target -&gt; /usr/lib/systemd/system/nut-driver.target\n\u2514\u2500\u2500 nut-server.service -&gt; /usr/lib/systemd/system/nut-server.service\n</code></pre>"},{"location":"linux/nut-monitor/#summary-of-services","title":"Summary of services","text":"<ul> <li>nut-server.service</li> <li>nut-monitor.service</li> <li>nut-driver-enumerator.service</li> </ul>"},{"location":"linux/nut-monitor/#post-installation","title":"Post Installation","text":"<p>A working installation can be checked with: </p> <pre><code>sudo upsd\n</code></pre> <p>should output something similar to:</p> <pre><code>Network UPS Tools upsd 2.8.3 release\nnot listening on ::1 port 3493\nnot listening on 127.0.0.1 port 3493\nno listening interface available\n</code></pre> <p>A proper configured server should show the following similar entries, I was running inside a tmux session and the first message is a broadcast. The following entries, <code>info_onbatt</code> and <code>ups-back-on-power</code> are from the the custom script.</p> <p><code>sudo journalctl -f</code> output</p> <pre><code>Broadcast message from nut@lyra (somewhere) (Mon Jun 23 17:36:42 2025):        \n\nUPS ctb-1200@localhost on battery                                              \n\n\nBroadcast message from nut@lyra (somewhere) (Mon Jun 23 17:36:42 2025):        \n\nUPS ctb-1200@localhost on battery                                              \n\nJun 23 17:36:42 lyra nut-monitor[8567]: UPS ctb-1200@localhost on battery\nJun 23 17:36:43 lyra upsmon[9256]: info_onbatt): Now on battery\n...\n[OMITTED]\n...                                                                              \nBroadcast message from nut@lyra (somewhere) (Mon Jun 23 17:36:52 2025):        \n\nUPS ctb-1200@localhost on line power                                           \n\n\nBroadcast message from nut@lyra (somewhere) (Mon Jun 23 17:36:52 2025):        \n\nUPS ctb-1200@localhost on line power                                           \n\nJun 23 17:36:52 lyra nut-monitor[8567]: UPS ctb-1200@localhost on line power\nJun 23 17:36:52 lyra upsmon[9395]: ups-back-on-power): UPS back on power\n</code></pre> <p><code>sudo journalctl -rxb | grep upsd</code> output</p> <pre><code>Jun 23 17:25:17 lyra upsd[8540]: User dnloop@::1 logged into UPS [ctb-1200]\nJun 23 17:25:13 lyra upsd[8540]: upsnotify: logged the systemd watchdog situation once, will not spam more about it\nJun 23 17:25:13 lyra upsd[8540]: upsnotify: failed to notify about state NOTIFY_STATE_READY_WITH_PID: no notification tech defined, will not spam more about it\nJun 23 17:25:13 lyra upsd[8540]: upsnotify: notify about state NOTIFY_STATE_READY_WITH_PID with libsystemd: was requested, but not running as a service unit now, will not spam more about it\nJun 23 17:25:13 lyra upsd[8540]: Running as foreground process, not saving a PID file\nJun 23 17:25:13 lyra upsd[8540]: Found 1 UPS defined in ups.conf\nJun 23 17:25:13 lyra upsd[8540]: Connected to UPS [ctb-1200]: blazer_usb-ctb-1200\nJun 23 17:25:13 lyra upsd[8540]: listening on 127.0.0.1 port 3493\nJun 23 17:25:13 lyra upsd[8540]: listening on ::1 port 3493\nJun 23 17:25:13 lyra nut-server[8540]: Network UPS Tools upsd 2.8.3 release\n</code></pre> <p><code>sudo journalctl -rxb | grep nut-server</code> output</p> <pre><code>Jun 23 17:25:17 lyra nut-server[8540]: User dnloop@::1 logged into UPS [ctb-1200]\nJun 23 17:25:13 lyra nut-server[8540]: upsnotify: logged the systemd watchdog situation once, will not spam more about it\nJun 23 17:25:13 lyra nut-server[8540]: upsnotify: failed to notify about state NOTIFY_STATE_READY_WITH_PID: no notification tech defined, will not spam more about it\nJun 23 17:25:13 lyra nut-server[8540]: upsnotify: notify about state NOTIFY_STATE_READY_WITH_PID with libsystemd: was requested, but not running as a service unit now, will not spam more about it\nJun 23 17:25:13 lyra nut-server[8540]: Running as foreground process, not saving a PID file\nJun 23 17:25:13 lyra nut-server[8540]: Found 1 UPS defined in ups.conf\nJun 23 17:25:13 lyra nut-server[8540]: Connected to UPS [ctb-1200]: blazer_usb-ctb-1200\nJun 23 17:25:13 lyra nut-server[8540]: listening on 127.0.0.1 port 3493       \nJun 23 17:25:13 lyra nut-server[8540]: listening on ::1 port 3493  \n</code></pre> <p>To get information about the ups run <code>upsc &lt;upsname&gt;</code></p> <pre><code>upsc ctb-1200\nbattery.charge: 100\nbattery.charge.low: 20\nbattery.charge.warning: 40\nbattery.voltage: 27.10\nbattery.voltage.high: 26.00\nbattery.voltage.low: 20.80\nbattery.voltage.nominal: 24.0\ndevice.type: ups\ndriver.debug: 0\ndriver.flag.allow_killpower: 0\ndriver.flag.ignorelb: enabled\ndriver.name: blazer_usb\ndriver.parameter.offdelay: 20\ndriver.parameter.ondelay: 30\ndriver.parameter.override.battery.charge.low: 20\ndriver.parameter.override.battery.charge.warning: 40\ndriver.parameter.pollinterval: 2\ndriver.parameter.port: auto\ndriver.parameter.synchronous: auto\ndriver.state: quiet\ndriver.version: 2.8.3\ndriver.version.internal: 0.21\ndriver.version.usb: libusb-1.0.29 (API: 0x0100010A)\ninput.current.nominal: 5.0\ninput.frequency: 50.0\ninput.frequency.nominal: 50\ninput.voltage: 224.4\ninput.voltage.fault: 224.4\ninput.voltage.nominal: 220\noutput.voltage: 226.5\nups.beeper.status: enabled\nups.delay.shutdown: 18\nups.delay.start: 1800\nups.load: 5\nups.productid: 5161\nups.status: OL\nups.type: offline / line interactive\nups.vendorid: 0665\n</code></pre>"},{"location":"linux/nut-monitor/#references","title":"References","text":"<ul> <li>Network UPS Tools</li> <li>NUT &amp; UPS, howto shut down client after 2 min on battery?</li> <li>nut \u2013 testing the shutdown mechanism</li> <li>6.\u00a0Configuration notes</li> </ul>"},{"location":"blog/archive/2025/","title":"2025","text":""},{"location":"blog/category/hello_world/","title":"Hello_World","text":""}]}